<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Optimized Lab Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <main class="auth-page">
        <div class="auth-card">
            <div class="auth-header">
                <i data-lucide="key-round" class="auth-icon"></i>
                <h1>Forgot Password</h1>
                <p>Enter your email address. For this demo, you'll be automatically redirected to the reset page if the email is found.</p>
            </div>
            <form id="forgotPasswordForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" placeholder="you@example.com" required>
                    <p class="error-message" id="emailError"></p>
                </div>
                <p id="formMessage" class="error-message" style="margin-bottom: 1rem;"></p> <!-- For success/general errors -->
                <button type="submit" class="button button-primary full-width">Send Reset Link</button>
            </form>
            <p class="auth-switch-link">
                Remember your password? <a href="index.html">Login</a>
            </p>
        </div>
    </main>
    <script src="js/constants.js"></script>
    <script src="js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) {
                window.lucide.createIcons();
            }
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const emailInput = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            const formMessage = document.getElementById('formMessage'); 

            if (forgotPasswordForm) {
                forgotPasswordForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    if(emailError) emailError.textContent = '';
                    if(formMessage) {
                        formMessage.textContent = '';
                        formMessage.className = 'error-message'; 
                    }

                    const email = emailInput.value.trim();
                    if (!email) {
                        if(emailError) emailError.textContent = 'Email is required.';
                        return;
                    }
                    if (!/\S+@\S+\.\S+/.test(email)) {
                         if(emailError) emailError.textContent = 'Please enter a valid email address.';
                        return;
                    }

                    const submitButton = forgotPasswordForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i data-lucide="loader-2" style="animation: spin 1s linear infinite; display: inline-block; margin-right: 0.5rem;"></i> Sending...';
                    if(window.lucide) window.lucide.createIcons();

                    try {
                        const response = await fetch(`${window.API_BASE_URL}/auth/forgot-password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email: email })
                        });
                        const data = await response.json();

                        if (response.ok) {
                            if (data.resetToken) { // Check if backend sent a token (for simulation)
                                window.location.href = `reset_password.html?token=${data.resetToken}`;
                            } else {
                                // Generic message if no token (e.g., user not found, but we don't reveal that)
                                if(formMessage) {
                                    formMessage.textContent = data.msg || 'If an account with that email exists, a password reset link has been sent (check backend console for the link/token).';
                                    formMessage.className = 'success-message visible'; 
                                }
                                forgotPasswordForm.reset();
                            }
                        } else {
                            if(formMessage) {
                                formMessage.textContent = data.msg || 'An error occurred. Please try again.';
                                formMessage.className = 'error-message visible';
                            }
                        }
                    } catch (error) {
                        console.error('Forgot password request failed:', error);
                        if(formMessage) {
                             formMessage.textContent = 'Could not connect to the server. Please try again later.';
                             formMessage.className = 'error-message visible';
                        }
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                         if(window.lucide) window.lucide.createIcons();
                    }
                });
            }
        });
    </script>
</body>
</html>
